name: Code Review

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  code-review:
    runs-on: macos-latest  # Use macOS for AppleScript testing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install vulture

      - name: Run tests with coverage
        run: |
          pytest --cov=apple_mail_mcp --cov-report=json --cov-report=term
        continue-on-error: true

      - name: Run code review agent
        id: review
        run: |
          python .github/scripts/code_review_agent.py \
            --min-score 70 \
            --min-coverage 80 \
            --output code-review-report.json \
            --verbose
        continue-on-error: true

      - name: Upload review report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-review-report
          path: code-review-report.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = JSON.parse(fs.readFileSync('code-review-report.json', 'utf8'));

              const statusEmoji = report.passed ? 'âœ…' : 'âŒ';
              const scoreColor = report.score >= 80 ? 'ğŸŸ¢' : report.score >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';

              // Group issues by severity
              const criticalIssues = report.issues.filter(i => i.severity === 'critical');
              const highIssues = report.issues.filter(i => i.severity === 'high');
              const mediumIssues = report.issues.filter(i => i.severity === 'medium');

              let comment = `## ${statusEmoji} Code Review Report\n\n`;
              comment += `**Overall Score:** ${scoreColor} ${report.score.toFixed(1)}/100\n`;
              comment += `**Status:** ${report.passed ? 'PASSED' : 'FAILED'}\n\n`;

              comment += `### Metrics\n`;
              comment += `- **Test Coverage:** ${report.metrics.test_coverage?.toFixed(1) || 'N/A'}%\n`;
              comment += `- **MCP Tools:** ${report.metrics.mcp_tools_count || 'N/A'}\n`;
              comment += `- **Total Issues:** ${report.metrics.total_issues || 0}\n\n`;

              if (criticalIssues.length > 0) {
                comment += `### ğŸ”´ Critical Issues (${criticalIssues.length})\n\n`;
                criticalIssues.slice(0, 5).forEach(issue => {
                  comment += `- **[${issue.category}]** ${issue.message}\n`;
                  if (issue.file_path) {
                    comment += `  - File: \`${issue.file_path}\``;
                    if (issue.line_number) comment += `:${issue.line_number}`;
                    comment += '\n';
                  }
                  if (issue.recommendation) {
                    comment += `  - ğŸ’¡ ${issue.recommendation}\n`;
                  }
                  comment += '\n';
                });
                if (criticalIssues.length > 5) {
                  comment += `_... and ${criticalIssues.length - 5} more critical issues_\n\n`;
                }
              }

              if (highIssues.length > 0) {
                comment += `### ğŸŸ  High Priority Issues (${highIssues.length})\n\n`;
                highIssues.slice(0, 3).forEach(issue => {
                  comment += `- **[${issue.category}]** ${issue.message}\n`;
                  if (issue.file_path) {
                    comment += `  - File: \`${issue.file_path}\``;
                    if (issue.line_number) comment += `:${issue.line_number}`;
                    comment += '\n';
                  }
                });
                if (highIssues.length > 3) {
                  comment += `_... and ${highIssues.length - 3} more high priority issues_\n\n`;
                }
              }

              if (mediumIssues.length > 0) {
                comment += `### ğŸŸ¡ Medium Priority Issues (${mediumIssues.length})\n\n`;
                comment += `_See full report artifact for details_\n\n`;
              }

              comment += `\n---\n`;
              comment += `ğŸ“Š Full report available in workflow artifacts\n`;
              comment += `ğŸ¤– Generated by Code Review Agent\n`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.error('Error reading or parsing report:', error);
            }

      - name: Check review status
        if: always()
        run: |
          if [ -f code-review-report.json ]; then
            passed=$(python -c "import json; print(json.load(open('code-review-report.json'))['passed'])")
            if [ "$passed" = "False" ]; then
              echo "âŒ Code review failed"
              exit 1
            else
              echo "âœ… Code review passed"
            fi
          else
            echo "âš ï¸ Review report not found"
            exit 1
          fi
